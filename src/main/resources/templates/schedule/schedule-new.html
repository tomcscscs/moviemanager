<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>스케쥴 등록 :: 영화관관리</title>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link th:href="@{/css/style.css}" rel="stylesheet" />
</head>
<body>
	<div class="container py-3">
		<ul class="nav justify-content-start nav-underline mb-2">
			<li class="nav-item py-1"><a class="nav-link "
				aria-current="page" th:href="@{/movie/all}">영화 관리</a></li>
			<li class="nav-item py-1"><a class="nav-link"
				th:href="@{/cinema/all}">상영관 관리</a></li>
			<li class="nav-item py-1"><a class="nav-link active"
				th:href="@{/schedule/all}">스케쥴 관리</a></li>
		</ul>
		<div class="border-bottom">
			<h2>상영시간 관리</h2>
		</div>
		<div class="py-2">
			<h5 class="text-success">스케쥴 추가</h5>
			<form th:action="@{/schedule/new}" method="post">
				<div class="row g-2 pb-1">
					<div class="col-4">
						<select id="movie" name="movieId"
							class="form-select form-select-sm">
							<option selected disabled>영화 선택</option>
							<th:block th:each="movie : ${movies}" th:object="${movie}">
								<option th:value="*{id}" th:text="|*{title} (*{runningTime} 분)|">..</option>
							</th:block>
						</select>
					</div>
					<div class="col-4">
						<select id="cinema" name="cinemaId"
							class="form-select form-select-sm cinedate">
							<option selected disabled>상영관 선택</option>

							<option th:each="cinema : ${cinemas}" th:value="${cinema.id}"
								th:text="${cinema.callName} + '-' + ${cinema.capacity} + '인석'">..</option>

						</select>
					</div>
					<div class="col-4 px-1">
						<input type="date" class="form-control form-control-sm cinedate"
							id="showDate" name="showDate" th:min="${today}" />
					</div>
				</div>
				<div th:if="${errorCode == 1}"
					class="alert alert-danger px-2 py-1 mb-1" style="font-size: small">
					상영시간 등록은 금일 이후 (<span th:text="${today}"></span>) 부터 가능합니다.
				</div>
				<div class="card mb-1">
					<div class="card-header p-2" id="moviePreview"
						style="font-size: small;">상영관과 날짜를 선택하세요.</div>
					<ul class="list-group list-group-flush" id="schedulePreview">
					</ul>
				</div>
				<div class="row g-2 pb-1" id="schedulePlan">
					<div class="col-3 px-1">
						<input type="time" class="form-control form-control-sm"
							name="showTime" />
					</div>
					<div class="col-3 px-1">
						<input type="time" class="form-control form-control-sm"
							name="showTime" />
					</div>
					<div class="col-3 px-1">
						<input type="time" class="form-control form-control-sm"
							name="showTime" />
					</div>
					<div class="col-3 px-1">
						<input type="time" class="form-control form-control-sm"
							name="showTime" />
					</div>
					<div class="col-3 px-1">
						<input type="time" class="form-control form-control-sm"
							name="showTime" />
					</div>
					<div class="col-3 px-1">
						<input type="time" class="form-control form-control-sm"
							name="showTime" />
					</div>
				</div>
				<div class="d-flex g-2 justify-content-end pt-1 border-top gap-2">
					<button type="button" class="btn btn-secondary btn-sm "
						data-bs-toggle="modal" data-bs-target="#settingModal">CUSTOMIZE
					</button>
					<button type="submit" class="btn btn-sm btn-secondary">스케쥴
						등록</button>
				</div>
			</form>
		</div>
	</div>
	<!-- Modal -->
	<div class="modal fade" id="settingModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header flex-column align-items-start">
					<h1 class="modal-title fs-6">상영시간 자동설정</h1>
					<div class="text-secondary">시작시간과 간격을 설정한 후 적용을 눌러주세요.</div>
					<div id="settingPreview" class="text-success"></div>
				</div>
				<div class="modal-body row g-1 gap-2">
					<div class="col-auto">
						<label>시작시간</label>
					</div>
					<div class="col-auto">
						<input type="time" class="form-control form-control-sm"
							id="settingStartTime" />
					</div>
					<div class="col-auto">
						<label>상영간격</label>
					</div>
					<div class="col-auto">
						<input type="number" class="form-control form-control-sm"
							id="settingGap" style="width: 60px;" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-light" data-bs-dismiss="modal">취소</button>
					<button type="button" class="btn btn-secondary" id="settingBt"
						data-bs-dismiss="modal">적용</button>
				</div>
			</div>
		</div>
	</div>




	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script
		src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<script>
	
	document.querySelector("#settingBt").addEventListener("click", function(e) {
		const startTime = document.querySelector("#settingStartTime").value;
		const gap = document.querySelector("#settingGap").value;
		const arr = startTime.split(":");
		const times = [];
		for(let standard = arr[0]*60 + arr[1]*1; standard < 1440; standard += gap*1 ) {
			times.push(standard);
		}
		const timeTable = times.map(function(val) {
			return Math.floor(val / 60) +":" + (val%60 <10 ? '0' + val%60 : val%60);
		});
		
		const divs = timeTable.map(val => {
			const div = document.createElement("div");
			div.className="col-3 px-1 ";
			const input = document.createElement("input");
				input.type="time";
				input.className="form-control form-control-sm";
				input.name="showTime";
				input.value=val;
			
			div.appendChild(input);
			
			return div;
		});
		const schedulePlan = document.querySelector("#schedulePlan");
		schedulePlan.innerHTML = "";
		divs.forEach(function(val) {
			schedulePlan.appendChild(val);
		});
	});
	
	
	
	/*
	$(".cinedate").on("change", function(e) {
			const cinemaId = $("#cinema").val();
			const showDate = $("#showDate").val();
			if(cinemaId && showDate) {
				window.alert(cinemaId+","+showDate);
			}
		
	});
	*/
	

	
	
	[...document.querySelectorAll(".cinedate")].forEach(function(elem){
		elem.addEventListener("change", function(e) {
			const $view = document.querySelector("#schedulePreview");
			$view.innerHTML = "";
			const cinemaId = document.querySelector("#cinema").value;
			console.log(document.querySelector("#cinema"));
			const cinemaCallName = document.querySelector("#cinema").options[document.querySelector("#cinema").selectedIndex].text;
			const showDate = document.querySelector("#showDate").value;
			if(cinemaId && showDate) {
				fetch("/schedule/api/cinema?cinemaId="+cinemaId+"&showDate="+showDate , {
					method : "get"
				}).then(function(response){
					return response.json();
				}).then(function(obj) {
					document.querySelector("#moviePreview").textContent = "["+cinemaCallName+"]의 [" + showDate+"] 예정 스케쥴표";
					if(obj.length == 0) {
						const li = document.createElement("li");
						li.className ="list-group-item";
						li.textContent = "등록된 상영 스케쥴이 없습니다.";
						$view.appendChild(li);
					}
					for(one of obj) {
						const  title = one.movie.title;
						const hour = one.showTime.split("T")[1].substr(0, 5);
						const li = document.createElement("li");
						li.className ="list-group-item";
						li.textContent = hour + " | " + title;
						$view.appendChild(li);
					}
				});
			}
		});
	});

	
	
	
	
	document.querySelector("#movie").addEventListener("change", function(e) {
		const movieId = e.target.value;
		const xhr = new XMLHttpRequest();
		xhr.open("get", "/schedule/api/movie?movieId="+movieId, true);
		xhr.onreadystatechange = function(e) {
			if(xhr.readyState == 4) {
				const obj = JSON.parse(xhr.responseText);
				var html =  obj.title+" / "+obj.genre.name+" / ";
				html +=  obj.ageCut == null ? '전체 관람가':obj.ageCut+'세 관람가';
				html += ' / ' + obj.runningTime +"분";
				document.querySelector("#settingPreview").innerHTML = html;
			}
		}
		xhr.send();
	});
	
	/*
		$("#movie").on("change", function(e) {
			const movieId = e.target.value;
			$.ajax({
				url : "/schedule/api/movie?movieId="+movieId,
				method: "get",
				dataType : "json"		
			}).done(function(obj) {
				console.log(obj);
				var html =  obj.title+" / "+obj.genre.name+" / ";
				html +=  obj.ageCut == null ? '전체 관람가':obj.ageCut+'세 관람가';
				html += ' / ' + obj.runningTime +"분";
				$("#moviePreview").html(html);
			});
		})
	*/
	</script>
</body>
</html>